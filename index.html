<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>JIGI v0.5.9</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --primary:#1976D2; --text:#232323; --muted:#9E9E9E; --bg:#FFFFFF; --chip:#F2F6FA; --ad:#E0E0E0; }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; display:flex; flex-direction:column; align-items:center; min-height:100svh;}
    header{ width:100%; padding:18px 20px 8px; text-align:center; position:relative }
    h1{ margin:0; font-size:24px; color:var(--primary) }
    #settingsBtn{ position:absolute; right:16px; top:16px; background:none; border:none; font-size:20px; cursor:pointer }
    .headline{ width:92%; max-width:720px; margin:10px auto 0; font-size:17px; line-height:1.5; text-align:left; min-height:52px }
    .wrap{ width:100%; max-width:720px; display:flex; flex-direction:column; align-items:center }
    .toolbar{ width:92%; display:flex; justify-content:space-between; align-items:center; gap:8px; margin:10px 0 6px }
    .loc{ font-size:12px; color:#666; min-height:18px }
    .btn{ padding:8px 10px; border:none; border-radius:10px; background:#EEF4FF; color:var(--primary); font-weight:600; font-size:12px; cursor:pointer }
    .toggle{ display:inline-flex; background:#EFF3F9; border-radius:12px; padding:2px; gap:2px }
    .tgbtn{ border:none; background:transparent; padding:6px 10px; border-radius:10px; font-size:12px; color:#555; cursor:pointer }
    .tgbtn.active{ background:#fff; color:#000; box-shadow:0 1px 3px rgba(0,0,0,0.08) }
    .chips{ display:flex; gap:8px; margin:10px 0 2px; padding:0 16px; flex-wrap:wrap; justify-content:flex-start; width:92%; min-height:36px }
    .chip{ padding:8px 12px; border-radius:16px; background:var(--chip); color:var(--text); font-size:14px }
    .chip.active{ background:var(--primary); color:#fff }
    #chart-wrap{ width:92%; height:160px; margin:8px 0 }
    canvas{ width:100% !important; height:100% !important; }
    .ad{ width:100%; height:100px; background:var(--ad); margin-top:auto; display:flex; align-items:center; justify-content:center; color:#555; font-size:14px }
    .toast{ position:fixed; top:8px; left:50%; transform:translateX(-50%); background:#000a; color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; display:none; z-index:99 }
    /* Settings panel & overlay */
    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.32); display:none; z-index:150 }
    #overlay.show{ display:block }
    #settingsPanel{ position:fixed; top:0; right:-320px; width:280px; height:100%; background:#fff; box-shadow:-2px 0 6px rgba(0,0,0,0.15); transition: right 0.25s ease; padding:20px; overflow-y:auto; z-index:200 }
    #settingsPanel.open{ right:0 }
    #settingsPanel h2{ font-size:16px; margin-top:0; color:var(--primary) }
    #settingsPanel label{ display:block; margin:10px 0 4px; font-size:13px; font-weight:600 }
    #settingsPanel select{ width:100%; padding:6px; font-size:13px; margin-bottom:12px }
    #settingsPanel .info{ font-size:12px; color:#555; margin-top:12px }
    /* Skeletons */
    .skeleton{ background: linear-gradient(90deg, #eee 25%, #f6f6f6 37%, #eee 63%); background-size: 400% 100%; animation: shimmer 1.2s infinite; border-radius:8px }
    @keyframes shimmer{ 0%{background-position:100% 0} 100%{background-position:-100% 0} }
    .sk-head{ width:92%; height:48px; margin-top:10px }
    .retry{ display:none; margin:8px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div id="overlay"></div>
  <header>
    <h1>JIGI</h1>
    <button id="settingsBtn">âš™ï¸</button>
  </header>
  <div class="headline" id="headline">ì˜¤ëŠ˜ì˜ ëŠë‚Œì„ ì •ë¦¬í•˜ê³  ìˆì–´ìš”â€¦</div>

  <div class="wrap">
    <div class="toolbar">
      <div class="loc" id="locLabel">ìœ„ì¹˜ í™•ì¸ ì¤‘â€¦</div>
      <div style="display:flex; gap:8px; align-items:center">
        <div class="toggle">
          <button class="tgbtn active" id="tgToday">ì˜¤ëŠ˜</button>
          <button class="tgbtn" id="tgTomorrow">ë‚´ì¼</button>
        </div>
        <button class="btn" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
    <div class="chips" id="chips"></div>
    <div id="chart-wrap">
      <canvas id="weatherChart"></canvas>
    </div>
    <button id="retryBtn" class="btn retry">ë‹¤ì‹œ ì‹œë„</button>
  </div>

  <div class="ad">Ad banner (320Ã—100)</div>

  <!-- Settings Panel -->
  <div id="settingsPanel">
    <h2>ì„¤ì •</h2>
    <label for="langSelect">ì–¸ì–´</label>
    <select id="langSelect">
      <option value="ko">í•œêµ­ì–´</option>
      <option value="en">English</option>
      <option value="ja">æ—¥æœ¬èª</option>
    </select>
    <label for="toneSelect">ë§íˆ¬</label>
    <select id="toneSelect">
      <option value="friend">ì¹œêµ¬ í†¤</option>
      <option value="butler">ì§‘ì‚¬ í†¤</option>
      <option value="formal">ê²©ì‹ í†¤</option>
      <option value="god">ë‚ ì”¨ì˜ ì‹ </option>
    </select>
    <div class="info">
      <p><b>ì•± ì´ë¦„</b>: JIGI</p>
      <p><b>ë²„ì „</b>: v0.5.9</p>
      <p><b>ë§Œë“  ì‚¬ëŒ</b>: ë¥˜ì¬ì˜</p>
      <p><b>ì´ë©”ì¼</b>: nolittleprince@gmail.com</p>
      <p><b>Instagram</b>: @nolittle.prince</p>
    </div>
  </div>

<script>
const state = { view:'today', data:null, lang:'ko', tone:'friend', locationName:'' };
const toast = (msg)=>{ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2400); };

// ---------- Utils ----------
function fmt(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function getDates(){ const now=new Date(); const today=new Date(now.getFullYear(),now.getMonth(),now.getDate()); const yest=new Date(today); yest.setDate(yest.getDate()-1); const tomo=new Date(today); tomo.setDate(tomo.getDate()+1); return {today:fmt(today), yesterday:fmt(yest), tomorrow:fmt(tomo)}; }
function withTimeout(promise, ms, label="ìš”ì²­"){ const ctrl = new AbortController(); const timer = setTimeout(()=>ctrl.abort(), ms); return Promise.race([ fetchPromiseWithSignal(promise, ctrl.signal), timeoutReject(ms, label) ]).finally(()=>clearTimeout(timer)); }
async function fetchPromiseWithSignal(promise, signal){ const res = await promise(signal); return res; }
function timeoutReject(ms, label){ return new Promise((_,rej)=> setTimeout(()=> rej(new Error(label+" ì‹œê°„ì´ˆê³¼")), ms)); }

// ---------- API ----------
async function fetchWeather(lat, lon){
  const { today, tomorrow, yesterday } = getDates();
  const base = "https://api.open-meteo.com/v1/forecast";
  const paramsTD = new URLSearchParams({ latitude:lat, longitude:lon, hourly:"temperature_2m,dewpoint_2m,windspeed_10m,precipitation_probability,uv_index", daily:"uv_index_max,temperature_2m_max,temperature_2m_min", timezone:"auto", start_date:today, end_date:tomorrow });
  const paramsY = new URLSearchParams({ latitude:lat, longitude:lon, hourly:"temperature_2m", timezone:"auto", start_date:yesterday, end_date:yesterday });

  const fetch1 = () => fetch(`${base}?${paramsTD}`);
  const fetch2 = () => fetch(`${base}?${paramsY}`);

  const [resTD, resY] = await Promise.all([ withTimeout(fetch1, 7000, "ë‚ ì”¨"), withTimeout(fetch2, 7000, "ì–´ì œë‚ ì”¨") ]);
  if (!resTD.ok || !resY.ok) throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
  return { td: await resTD.json(), y: await resY.json() };
}

async function fetchLocationName(lat, lon, lang){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=${lang}`;
    const res = await withTimeout((signal)=> fetch(url, {signal}), 3500, "ì§€ëª…");
    if(!res.ok) return "";
    const data = await res.json();
    const a = data.address || {};
    return a.city || a.town || a.village || a.county || data.display_name || "";
  }catch(e){ return ""; }
}

// ---------- Data helpers ----------
const buckets=[{name:"ì•„ì¹¨",range:[6,11]},{name:"ì ì‹¬",range:[12,16]},{name:"ì €ë…",range:[17,20]},{name:"ë°¤",range:[21,23],alt:[0,5]}];
function avgArr(a){ if(!a || !a.length) return 0; return a.reduce((x,y)=>x+y,0)/a.length; }
function avgSlice(arr,s,e){ const a=arr.slice(s,e+1); return avgArr(a); }
function avgBucket(arr,b){ const main=avgSlice(arr,b.range[0],b.range[1]); if(!b.alt) return main; const a=avgSlice(arr,b.alt[0],b.alt[1]); return (main*3+a*1)/4; }

function splitByDate(hourly){
  const map={};
  hourly.time.forEach((iso,i)=>{
    const d=new Date(iso);
    const key=fmt(new Date(d.getFullYear(),d.getMonth(),d.getDate()));
    (map[key]||(map[key]=[])).push(i);
  });
  return map;
}
function pickDay(td,dateStr){
  if(!td || !td.hourly) return null;
  const h=td.hourly;
  const groups=splitByDate(h);
  const idxs=groups[dateStr];
  if(!idxs) return null;
  const pick=(arr)=> (arr? idxs.map(i=>arr[i]) : []);
  const dayIdx = (td.daily && td.daily.time) ? td.daily.time.indexOf(dateStr) : -1;
  return {
    t: pick(h.temperature_2m),
    dp: pick(h.dewpoint_2m),
    wind: pick(h.windspeed_10m),
    rain: pick(h.precipitation_probability),
    uvh: pick(h.uv_index),
    uvmax: (td.daily && dayIdx>=0 && td.daily.uv_index_max) ? td.daily.uv_index_max[dayIdx] : null,
    tmax: (td.daily && dayIdx>=0 && td.daily.temperature_2m_max) ? td.daily.temperature_2m_max[dayIdx] : null,
    tmin: (td.daily && dayIdx>=0 && td.daily.temperature_2m_min) ? td.daily.temperature_2m_min[dayIdx] : null
  };
}

// ---------- Solar terms ----------
const SOLAR_KO=[{m:2,d:4,n:"ì…ì¶˜"},{m:2,d:19,n:"ìš°ìˆ˜"},{m:3,d:5,n:"ê²½ì¹©"},{m:3,d:20,n:"ì¶˜ë¶„"},{m:4,d:4,n:"ì²­ëª…"},{m:4,d:20,n:"ê³¡ìš°"},{m:5,d:5,n:"ì…í•˜"},{m:5,d:21,n:"ì†Œë§Œ"},{m:6,d:5,n:"ë§ì¢…"},{m:6,d:21,n:"í•˜ì§€"},{m:7,d:7,n:"ì†Œì„œ"},{m:7,d:23,n:"ëŒ€ì„œ"},{m:8,d:7,n:"ì…ì¶”"},{m:8,d:23,n:"ì²˜ì„œ"},{m:9,d:7,n:"ë°±ë¡œ"},{m:9,d:23,n:"ì¶”ë¶„"},{m:10,d:8,n:"í•œë¡œ"},{m:10,d:24,n:"ìƒê°•"},{m:11,d:7,n:"ì…ë™"},{m:11,d:22,n:"ì†Œì„¤"},{m:12,d:7,n:"ëŒ€ì„¤"},{m:12,d:22,n:"ë™ì§€"},{m:1,d:6,n:"ì†Œí•œ"},{m:1,d:20,n:"ëŒ€í•œ"}];
const SOLAR_EN={"ì…ì¶˜":"Start of Spring","ìš°ìˆ˜":"Rain Water","ê²½ì¹©":"Waking of Insects","ì¶˜ë¶„":"Spring Equinox","ì²­ëª…":"Clear and Bright","ê³¡ìš°":"Grain Rain","ì…í•˜":"Start of Summer","ì†Œë§Œ":"Lesser Fullness","ë§ì¢…":"Grain in Ear","í•˜ì§€":"Summer Solstice","ì†Œì„œ":"Lesser Heat","ëŒ€ì„œ":"Greater Heat","ì…ì¶”":"Start of Autumn","ì²˜ì„œ":"Limit of Heat","ë°±ë¡œ":"White Dew","ì¶”ë¶„":"Autumn Equinox","í•œë¡œ":"Cold Dew","ìƒê°•":"Frost Descent","ì…ë™":"Start of Winter","ì†Œì„¤":"Lesser Snow","ëŒ€ì„¤":"Greater Snow","ë™ì§€":"Winter Solstice","ì†Œí•œ":"Lesser Cold","ëŒ€í•œ":"Greater Cold"};
const SOLAR_JA={"ì…ì¶˜":"ç«‹æ˜¥","ìš°ìˆ˜":"é›¨æ°´","ê²½ì¹©":"å•“èŸ„","ì¶˜ë¶„":"æ˜¥åˆ†","ì²­ëª…":"æ¸…æ˜","ê³¡ìš°":"ç©€é›¨","ì…í•˜":"ç«‹å¤","ì†Œë§Œ":"å°æº€","ë§ì¢…":"èŠ’ç¨®","í•˜ì§€":"å¤è‡³","ì†Œì„œ":"å°æš‘","ëŒ€ì„œ":"å¤§æš‘","ì…ì¶”":"ç«‹ç§‹","ì²˜ì„œ":"å‡¦æš‘","ë°±ë¡œ":"ç™½éœ²","ì¶”ë¶„":"ç§‹åˆ†","í•œë¡œ":"å¯’éœ²","ìƒê°•":"éœœé™","ì…ë™":"ç«‹å†¬","ì†Œì„¤":"å°é›ª","ëŒ€ì„¤":"å¤§é›ª","ë™ì§€":"å†¬è‡³","ì†Œí•œ":"å°å¯’","ëŒ€í•œ":"å¤§å¯’"};
function solarTerm(today, lang){
  const y=today.getFullYear();
  const list=SOLAR_KO.map(t=>({date:new Date(y,t.m-1,t.d),n:t.n})).sort((a,b)=>a.date-b.date);
  let cur=list[0];
  for(const t of list){ if(today>=t.date) cur=t; }
  const name=cur.n;
  if(lang==='ko') return name;
  if(lang==='en') return SOLAR_EN[name]||name;
  if(lang==='ja') return SOLAR_JA[name]||name;
  return name;
}

// ---------- Headline (tones & phrasing) ----------
function buildHeadline(day,ref,mode,tone,lang){
  try{
    if(!day || !ref || !day.t || !ref.t || !day.t.length || !ref.t.length){
      return (lang==='ko')? "ë‚ ì”¨ ë°ì´í„°ë¥¼ ì •ë¦¬í•˜ëŠ” ì¤‘ì´ì—ìš”â€¦ ì ì‹œë§Œìš”!" :
             (lang==='ja')? "å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†ä¸­ã§ã™â€¦ å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚" :
                            "Fetching weatherâ€¦ one moment!";
    }
    const tAvg = avgArr(day.t);
    const rAvg = avgArr(ref.t);
    const delta = tAvg - rAvg;
    const abs = Math.abs(delta);

    const dp = day.dp && day.dp.length ? avgSlice(day.dp,12,15) : null;
    const rain = day.rain && day.rain.length ? avgSlice(day.rain,12,15) : 0;
    const wind = day.wind && day.wind.length ? avgSlice(day.wind,12,15) : 0;
    const uv = (day.uvh && day.uvh.length) ? avgSlice(day.uvh,11,13) : (day.uvmax ?? 0);

    // phrase fix
    let lead="";
    const baseToday   = (lang==='ko')? "ì˜¤ëŠ˜ì€ ì–´ì œë‘" : (lang==='ja'?"ä»Šæ—¥ã¯æ˜¨æ—¥ã¨":"Today vs Yesterday");
    const baseTomorrow= (lang==='ko')? "ë‚´ì¼ë„ ì˜¤ëŠ˜ì´ë‘" : (lang==='ja'?"æ˜æ—¥ã‚‚ä»Šæ—¥ã¨":"Tomorrow vs Today");
    const compToday   = (lang==='ko')? "ì˜¤ëŠ˜ì€ ì–´ì œë³´ë‹¤" : (lang==='ja'?"ä»Šæ—¥ã¯æ˜¨æ—¥ã‚ˆã‚Š":"Today than Yesterday");
    const compTomorrow= (lang==='ko')? "ë‚´ì¼ì€ ì˜¤ëŠ˜ë³´ë‹¤" : (lang==='ja'?"æ˜æ—¥ã¯ä»Šæ—¥ã‚ˆã‚Š":"Tomorrow than Today");

    const samePhrases = (lang==='ko')? ["ê±°ì˜ ê°™ì•„ìš”","í° ì°¨ì´ ì—†ì–´ìš”"] :
                        (lang==='ja')? ["ã»ã¼åŒã˜ã§ã™","å¤§ããªå·®ã¯ã‚ã‚Šã¾ã›ã‚“"] :
                                        ["about the same","no big change"];
    const smallUp     = (lang==='ko')? "ì¡°ê¸ˆ ë” í¬ê·¼í•´ìš”" : (lang==='ja'?"å°‘ã—æš–ã‹ã„ã§ã™":"a bit warmer");
    const smallDown   = (lang==='ko')? "ì‚´ì§ ì„œëŠ˜í•˜ë„¤ìš”" : (lang==='ja'?"å°‘ã—æ¶¼ã—ã„ã§ã™":"a bit cooler");
    const bigUp       = (lang==='ko')? "í™•ì‹¤íˆ ë”°ëœ»í•´ìš”" : (lang==='ja'?"ã¯ã£ãã‚Šæš–ã‹ã„ã§ã™":"noticeably warmer");
    const bigDown     = (lang==='ko')? "í™•ì‹¤íˆ ì„ ì„ í•´ìš”" : (lang==='ja'?"ã¯ã£ãã‚Šæ¶¼ã—ã„ã§ã™":"noticeably cooler");

    if (abs <= 0.5){
      const base = (mode==='today') ? baseToday : baseTomorrow;
      lead = `${base} ${samePhrases[Math.floor(Math.random()*samePhrases.length)]}`;
    } else if (abs <= 1.5){
      const base = (mode==='today') ? compToday : compTomorrow;
      lead = `${base} ${delta>0 ? smallUp : smallDown}`;
    } else {
      const base = (mode==='today') ? compToday : compTomorrow;
      lead = `${base} ${delta>0 ? bigUp : bigDown}`;
    }

    const humidTone = (dp===null) ? (lang==='ko'?"ìƒì¾Œí•´ìš”":(lang==='ja'?"ã•ã‚ã‚„ã‹ã§ã™":"feels fresh"))
                      : (dp>=24 ? (lang==='ko'?"ë§ì´ ëˆì í•´ìš”":(lang==='ja'?"ã‹ãªã‚Šè’¸ã—æš‘ã„ã§ã™":"very muggy"))
                      : (dp>=22 ? (lang==='ko'?"ì¢€ ìŠµí•´ìš”":(lang==='ja'?"å°‘ã—è’¸ã—ã¾ã™":"quite humid"))
                      : (dp>=19 ? (lang==='ko'?"ì‚´ì§ ìŠµí•´ìš”":(lang==='ja'?"ã‚„ã‚„æ¹¿ã£ã½ã„ã§ã™":"slightly humid"))
                                : (lang==='ko'?"ìƒì¾Œí•´ìš”":(lang==='ja'?"ã•ã‚ã‚„ã‹ã§ã™":"fresh"))));

    let windTone=""; if(wind>=8) windTone=(lang==='ko')?"ë°”ëŒì´ ê°•í•´ìš”":(lang==='ja'?"é¢¨ãŒå¼·ã„ã§ã™":"windy");
    else if(wind>=5) windTone=(lang==='ko')?"ë°”ëŒì´ ì¡°ê¸ˆ ë¶ˆì–´ìš”":(lang==='ja'?"ã‚„ã‚„é¢¨ãŒã‚ã‚Šã¾ã™":"a bit breezy");

    let uvTone = (uv>=8)? ((lang==='ko')?"ìì™¸ì„  ë§¤ìš° ê°•í•´ìš”":(lang==='ja'?"ç´«å¤–ç·šãŒã¨ã¦ã‚‚å¼·ã„ã§ã™":"UV very high"))
               : (uv>=6)? ((lang==='ko')?"ìì™¸ì„ ì´ ê°•í•´ìš”":(lang==='ja'?"ç´«å¤–ç·šãŒå¼·ã„ã§ã™":"UV high"))
               : (uv>=3)? ((lang==='ko')?"ìì™¸ì„  ë³´í†µì´ì—ìš”":(lang==='ja'?"ç´«å¤–ç·šã¯æ™®é€šã§ã™":"UV moderate"))
                        : ((lang==='ko')?"ìì™¸ì„  ë‚®ì•„ìš”":(lang==='ja'?"ç´«å¤–ç·šã¯ä½ã„ã§ã™":"UV low"));

    const rainTone = (rain>=60)? ((lang==='ko')?"ë¹„ ì˜¬ ìˆ˜ë„ ìˆì–´ìš”":(lang==='ja'?"é›¨ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™":"chance of rain"))
                                : ((lang==='ko')?"ë¹„ ê±±ì •ì€ ì—†ì–´ìš”":(lang==='ja'?"é›¨ã®å¿ƒé…ã¯ã‚ã‚Šã¾ã›ã‚“":"no rain expected"));

    const term = solarTerm(new Date(), state.lang);
    const termTxt = (lang==='ko') ? `ì§€ê¸ˆì€ ${term}ì´ì—ìš”.`
                  : (lang==='ja') ? `ä»Šã¯ã€Œ${term}ã€ã®é ƒã§ã™ã€‚`
                                  : `Now around "${(SOLAR_EN[term]||term)}".`;

    return [lead, humidTone, windTone, `${uvTone}. ${rainTone} ${termTxt}`].filter(Boolean).join(" ");
  }catch(e){
    console.error(e);
    return (lang==='ko')? "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”." :
           (lang==='ja')? "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ›´æ–°ã—ã¦ãã ã•ã„ã€‚" :
                          "Couldn't load data. Please refresh.";
  }
}

// ---------- Chart ----------
function drawChart(seriesBase,seriesCompare,viewMode){
  const ctx=document.getElementById('weatherChart');
  const labels=["ì•„ì¹¨","ì ì‹¬","ì €ë…","ë°¤"];
  const nowH=new Date().getHours(); let nowIdx=3;
  if(nowH>=6&&nowH<=11)nowIdx=0; else if(nowH>=12&&nowH<=16)nowIdx=1; else if(nowH>=17&&nowH<=20)nowIdx=2;

  const nowLinePlugin={ id:'nowLine', afterDatasetsDraw(chart){ if(viewMode!=='today')return; const {ctx,chartArea:{top,bottom},scales:{x}}=chart; const pos=x.getPixelForValue(nowIdx); ctx.save(); ctx.lineWidth=1.2; ctx.strokeStyle='red'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(pos, top); ctx.lineTo(pos, bottom); ctx.stroke(); ctx.restore(); } };

  if(window.__jigiChart){ window.__jigiChart.destroy(); }
  window.__jigiChart=new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[
      {label:'ê¸°ì¤€', data:seriesBase, tension:0.35, borderColor:'#B0BEC5', pointRadius:2 },
      {label:'ë¹„êµ', data:seriesCompare, tension:0.35, borderColor:getComputedStyle(document.documentElement).getPropertyValue('--primary').trim(), pointRadius:3 }
    ]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } },
      layout:{ padding:{ left:6, right:6, top:2, bottom:0 } },
      scales:{ x:{ grid:{ display:false } }, y:{ grid:{ color:'#ECEFF1' }, ticks:{ maxTicksLimit:4, callback:(v)=> v+'Â°' } } },
      animation:false
    },
    plugins:[nowLinePlugin]
  });
}

// ---------- App flow ----------
async function init(lat,lon,label=""){
  document.getElementById('locLabel').textContent = label || "í˜„ì¬ ìœ„ì¹˜";
  document.getElementById('headline').textContent = "ì˜¤ëŠ˜ì˜ ëŠë‚Œì„ ì •ë¦¬í•˜ê³  ìˆì–´ìš”â€¦";
  document.getElementById('retryBtn').style.display='none';

  try{
    const { td, y } = await fetchWeather(lat, lon);
    state.data = { td, y };
    render();
    fetchLocationName(lat, lon, state.lang).then(name=>{
      if(name){ state.locationName=name; document.getElementById('locLabel').textContent = name; }
    });
  }catch(e){
    console.error(e);
    document.getElementById('headline').textContent = "ë„¤íŠ¸ì›Œí¬ê°€ ëŠë ¤ìš”. ë‹¤ì‹œ ì‹œë„í•´ë³¼ê¹Œìš”?";
    document.getElementById('retryBtn').style.display='inline-block';
  }
}

function render(){
  const { today, tomorrow } = getDates();
  const td=state.data?.td, y=state.data?.y;
  const todayArr=pickDay(td,today);
  const tomorrowArr=pickDay(td,tomorrow);
  const yestArr = (y && y.hourly && y.hourly.temperature_2m) ? { t: y.hourly.temperature_2m } : null;

  // Null-safe: if any is missing, keep friendly fallback
  if(state.view==='today' && todayArr && yestArr){
    const head = buildHeadline(todayArr, yestArr, "today", state.tone, state.lang);
    document.getElementById('headline').textContent = head;
    const baseSeries = buckets.map(b=>avgBucket(yestArr.t,b));
    const compSeries = buckets.map(b=>avgBucket(todayArr.t,b));
    drawChart(baseSeries, compSeries, state.view);
  }else if(state.view==='tomorrow' && tomorrowArr && todayArr){
    const head = buildHeadline(tomorrowArr, todayArr, "tomorrow", state.tone, state.lang);
    document.getElementById('headline').textContent = head;
    const baseSeries = buckets.map(b=>avgBucket(todayArr.t,b));
    const compSeries = buckets.map(b=>avgBucket(tomorrowArr.t,b));
    drawChart(baseSeries, compSeries, state.view);
  }else{
    document.getElementById('headline').textContent = "ë°ì´í„°ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
  }

  // Chips (guarded)
  const chipsEl=document.getElementById('chips'); chipsEl.innerHTML="";
  const src = (state.view==='today') ? todayArr : tomorrowArr;
  if(src){
    const dp = (src.dp && src.dp.length)? avgSlice(src.dp,12,15) : null;
    const rain = (src.rain && src.rain.length)? avgSlice(src.rain,12,15) : 0;
    const wind = (src.wind && src.wind.length)? avgSlice(src.wind,12,15) : 0;
    const uvh  = (src.uvh && src.uvh.length)? avgSlice(src.uvh,11,13) : (src.uvmax ?? 0);
    const chips=[]; if(dp!==null && dp>=19) chips.push("ğŸ§µ í†µí’ ì¢‹ì€ ì˜·"); if(rain>=60) chips.push("â˜‚ ìš°ì‚° ì±™ê¸°ê¸°"); if(wind>=7) chips.push("ğŸ§¥ ë°”ëŒë§‰ì´"); if(uvh>=7) chips.push("ğŸ§´ ì„ í¬ë¦¼/ëª¨ì");
    Array.from(new Set(chips)).slice(0,3).forEach((t,i)=>{ const d=document.createElement('div'); d.className='chip'+(i===0?' active':''); d.textContent=t; chipsEl.appendChild(d); });
  }
}

// ---------- Geolocation & UI ----------
function useGeolocation(){
  if(!navigator.geolocation){
    toast("ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”. ì„œìš¸ë¡œ ë³´ì—¬ë“œë¦´ê²Œìš”.");
    init(37.5665,126.9780,"ì„œìš¸(ê¸°ë³¸)");
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos)=>{ const { latitude:lat, longitude:lon } = pos.coords; init(lat, lon, "í˜„ì¬ ìœ„ì¹˜"); },
    (err)=>{ toast("ìœ„ì¹˜ ê¶Œí•œì´ ì—†ì–´ ì„œìš¸ë¡œ ë³´ì—¬ë“œë¦´ê²Œìš”."); init(37.5665,126.9780,"ì„œìš¸(ê¸°ë³¸)"); },
    { enableHighAccuracy:false, timeout:8000, maximumAge:300000 }
  );
}

// Slow-load hint after 4s
setTimeout(()=>{ if(!state.data){ document.getElementById('locLabel').textContent = "ë„¤íŠ¸ì›Œí¬ê°€ ëŠë ¤ìš”â€¦ ì ì‹œë§Œìš”"; } }, 4000);

// UI handlers
const panel = document.getElementById('settingsPanel');
const overlay = document.getElementById('overlay');
function togglePanel(open){ if(open===undefined) open = !panel.classList.contains('open'); panel.classList.toggle('open', open); overlay.classList.toggle('show', open); }
document.getElementById('settingsBtn').addEventListener('click',()=>togglePanel());
overlay.addEventListener('click',()=>togglePanel(false));
document.getElementById('tgToday').addEventListener('click',()=>{state.view='today';document.getElementById('tgToday').classList.add('active');document.getElementById('tgTomorrow').classList.remove('active'); if(state.data) render();});
document.getElementById('tgTomorrow').addEventListener('click',()=>{state.view='tomorrow';document.getElementById('tgTomorrow').classList.add('active');document.getElementById('tgToday').classList.remove('active'); if(state.data) render();});
document.getElementById('btnRefresh').addEventListener('click',()=>useGeolocation());
document.getElementById('retryBtn').addEventListener('click',()=>useGeolocation());
document.getElementById('langSelect').addEventListener('change',(e)=>{state.lang=e.target.value; toast("ì–¸ì–´ ì„¤ì •ì€ ì§€ëª…/ë¬¸ì¥ì— ë°˜ì˜ë©ë‹ˆë‹¤."); if(state.locationName){ document.getElementById('locLabel').textContent="ì§€ëª… ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦"; } if(navigator.geolocation) navigator.geolocation.getCurrentPosition((pos)=> fetchLocationName(pos.coords.latitude,pos.coords.longitude,state.lang).then(name=>{ if(name){ state.locationName=name; document.getElementById('locLabel').textContent=name; } else { document.getElementById('locLabel').textContent="í˜„ì¬ ìœ„ì¹˜"; } })); if(state.data) render();});
document.getElementById('toneSelect').addEventListener('change',(e)=>{state.tone=e.target.value; if(state.data) render();});

// Start
useGeolocation();
</script>
</body>
</html>
