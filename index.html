<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>yestodmorrow kk â€” Yesterday Â· Today Â· Tomorrow</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#0b1020; --muted:#697387; --line:#e6e9ef; --card:#f7f9fc;
      --up:#ef4444; --down:#10b981; --same:#9aa3b2; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Noto Sans JP",sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{height:100vh;display:grid;grid-template-rows:auto 1fr auto;max-width:780px;margin:0 auto;padding:14px;gap:10px}
    header,footer{display:flex;align-items:center;justify-content:space-between}
    header .brand{display:flex;align-items:center;gap:8px}
    .badge{border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px;color:var(--accent)}
    .loc{font-weight:700}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .btn{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer}
    .lang button{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:999px;font-size:12px;margin-left:6px;cursor:pointer}
    .lang button.active{border-color:var(--accent);color:var(--accent);font-weight:700}
    main{display:grid;grid-template-rows:auto auto 1fr;gap:10px;overflow:auto}
    .headline{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;font-size:16px;line-height:1.4}
    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0 0 4px 0;font-size:12px;color:var(--muted);font-weight:700}
    .big{font-size:28px;font-weight:800}
    .row{display:flex;justify-content:space-between;font-size:14px}
    .delta.up{color:var(--up)} .delta.down{color:var(--down)} .delta.same{color:var(--same)}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .slot{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fff}
    .slot h4{margin:0 0 6px 0;font-size:12px;color:var(--muted)}
    .slot .line{font-size:14px}
    .tips{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:#fff;padding:6px 10px;border-radius:999px;font-size:12px}
    footer .right{display:flex;align-items:center;gap:8px}
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <span class="badge">yestodmorrow kk</span>
        <div>
          <div class="loc" id="locText">Seoul</div>
          <div class="muted small" id="timeText"></div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <button class="btn" id="locBtn">ğŸ“ ìœ„ì¹˜ ì¬ì„¤ì •</button>
        <div class="lang">
          <button data-lang="ko" class="active">KO</button>
          <button data-lang="en">EN</button>
          <button data-lang="ja">JA</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Headline 1: Today vs Yesterday -->
      <div class="headline" id="headline1">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
      <!-- Headline 2: Tomorrow vs Today -->
      <div class="headline" id="headline2">ë‚´ì¼ ë¯¸ë¦¬ë³´ê¸° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>

      <!-- Cards: Yesterday vs Now -->
      <div class="cards">
        <div class="card">
          <h3 id="yTitle">ì–´ì œ ì´ ì‹œê°„</h3>
          <div class="big" id="yTemp">â€”</div>
          <div class="row"><span id="yRainLbl">ê°•ìˆ˜</span><span id="yRain">â€”</span></div>
          <div class="row"><span id="yWindLbl">ë°”ëŒ</span><span id="yWind">â€”</span></div>
        </div>
        <div class="card">
          <h3 id="tTitle">ì˜¤ëŠ˜ ì§€ê¸ˆ</h3>
          <div class="big" id="tTemp">â€” <span class="delta same" id="tTempDelta">â‰ˆ0Â°C</span></div>
          <div class="row"><span id="tRainLbl">ê°•ìˆ˜</span><span id="tRain">â€” <span class="delta same" id="tRainDelta"></span></span></div>
          <div class="row"><span id="tWindLbl">ë°”ëŒ</span><span id="tWind">â€” <span class="delta same" id="tWindDelta"></span></span></div>
        </div>
      </div>

      <!-- Slots: AM/Noon/Eve for Today; Tomorrow preview line below -->
      <div class="grid3">
        <div class="slot">
          <h4 id="amLbl">ì•„ì¹¨(6â€“9)</h4>
          <div class="line" id="amLine">â€”</div>
          <div class="small muted" id="amTom">ë‚´ì¼: â€”</div>
        </div>
        <div class="slot">
          <h4 id="noonLbl">ì ì‹¬(12â€“15)</h4>
          <div class="line" id="noonLine">â€”</div>
          <div class="small muted" id="noonTom">ë‚´ì¼: â€”</div>
        </div>
        <div class="slot">
          <h4 id="eveLbl">ì €ë…(18â€“21)</h4>
          <div class="line" id="eveLine">â€”</div>
          <div class="small muted" id="eveTom">ë‚´ì¼: â€”</div>
        </div>
      </div>
    </main>

    <footer>
      <div class="tips">
        <span class="pill" id="tip1">â˜‚ ìš°ì‚° í•„ìš” ì—†ìŒ</span>
        <span class="pill" id="tip2">ğŸ§¥ ê²‰ì˜· ì„ íƒ</span>
        <span class="pill" id="tip3">â˜€ ìì™¸ì„  ì£¼ì˜</span>
      </div>
      <div class="right small muted">Data: Open-Meteo â€¢ yestodmorrow kk v0.2</div>
    </footer>
  </div>

  <script>
    // ===== ì‰¬ìš´ ìš©ì–´ =====
    // API: ë°ì´í„°ë¥¼ ì œê³µí•˜ëŠ” ì„œë²„ì˜ ì£¼ì†Œ(ì „í™”ë²ˆí˜¸).
    // JSON: í‘œ í˜•íƒœì˜ í…ìŠ¤íŠ¸ ë°ì´í„° í¬ë§·.
    // fetch(): ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ëª…ë ¹.
    // timezone=auto: í˜„ì§€ ì‹œê°„ëŒ€ë¡œ ìë™ ë³€í™˜.
    const texts = {
      ko: {
        yTitle: "ì–´ì œ ì´ ì‹œê°„",
        tTitle: "ì˜¤ëŠ˜ ì§€ê¸ˆ",
        am: "ì•„ì¹¨(6â€“9)", noon: "ì ì‹¬(12â€“15)", eve: "ì €ë…(18â€“21)",
        rain: "ê°•ìˆ˜", wind: "ë°”ëŒ",
        head1: (dT, rainMsg, windMsg)=> `ì˜¤ëŠ˜ì€ ì–´ì œë³´ë‹¤ ${tempPhrase(dT,'ko')}${rainMsg? " Â· "+rainMsg:""}${windMsg? " Â· "+windMsg:""}`,
        head2: (dT, rainMsg, windMsg)=> `ë‚´ì¼ì€ ì˜¤ëŠ˜ë³´ë‹¤ ${tempPhrase(dT,'ko')}${rainMsg? " Â· "+rainMsg:""}${windMsg? " Â· "+windMsg:""}`,
        tips: { noUmb:"â˜‚ ìš°ì‚° í•„ìš” ì—†ìŒ", takeUmb:"â˜‚ ìš°ì‚° ì±™ê¸°ê¸°", outerMaybe:"ğŸ§¥ ê²‰ì˜· ì„ íƒ", outerNeed:"ğŸ§¥ ê²‰ì˜· í•„ìš”", uv:"â˜€ ìì™¸ì„  ì£¼ì˜" },
        resetLoc:"ğŸ“ ìœ„ì¹˜ ì¬ì„¤ì •",
        loading:"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦",
        loading2:"ë‚´ì¼ ë¯¸ë¦¬ë³´ê¸° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦"
      },
      en: {
        yTitle: "This hour yesterday",
        tTitle: "Now today",
        am: "Morning (6â€“9)", noon: "Noon (12â€“15)", eve: "Evening (18â€“21)",
        rain: "Precip", wind: "Wind",
        head1: (dT, rainMsg, windMsg)=> `Today feels ${tempPhrase(dT,'en')}${rainMsg? " Â· "+rainMsg:""}${windMsg? " Â· "+windMsg:""}`,
        head2: (dT, rainMsg, windMsg)=> `Tomorrow will feel ${tempPhrase(dT,'en')}${rainMsg? " Â· "+rainMsg:""}${windMsg? " Â· "+windMsg:""}`,
        tips: { noUmb:"â˜‚ No umbrella", takeUmb:"â˜‚ Take umbrella", outerMaybe:"ğŸ§¥ Light layer optional", outerNeed:"ğŸ§¥ Bring a jacket", uv:"â˜€ UV caution" },
        resetLoc:"ğŸ“ Reset location",
        loading:"Loadingâ€¦", loading2:"Loading tomorrowâ€¦"
      },
      ja: {
        yTitle: "æ˜¨æ—¥ã®ã“ã®æ™‚é–“",
        tTitle: "ä»Šæ—¥ãƒ»ä»Š",
        am: "æœ(6â€“9)", noon: "æ˜¼(12â€“15)", eve: "å¤•(18â€“21)",
        rain: "é™æ°´", wind: "é¢¨",
        head1: (dT, rainMsg, windMsg)=> `ä»Šæ—¥ã¯æ˜¨æ—¥ã‚ˆã‚Š${tempPhrase(dT,'ja')}${rainMsg? "ãƒ»"+rainMsg:""}${windMsg? "ãƒ»"+windMsg:""}`,
        head2: (dT, rainMsg, windMsg)=> `æ˜æ—¥ã¯ä»Šæ—¥ã‚ˆã‚Š${tempPhrase(dT,'ja')}${rainMsg? "ãƒ»"+rainMsg:""}${windMsg? "ãƒ»"+windMsg:""}`,
        tips: { noUmb:"â˜‚ å‚˜ä¸è¦", takeUmb:"â˜‚ å‚˜ã‚’æŒã¤", outerMaybe:"ğŸ§¥ ä¸Šç€ã¯ãŠå¥½ã¿ã§", outerNeed:"ğŸ§¥ ä¸Šç€ãŒå¿…è¦", uv:"â˜€ ç´«å¤–ç·šæ³¨æ„" },
        resetLoc:"ğŸ“ å†è¨­å®š",
        loading:"èª­ã¿è¾¼ã¿ä¸­â€¦", loading2:"æ˜æ—¥ã®èª­ã¿è¾¼ã¿ä¸­â€¦"
      }
    };
    let LANG='ko';
    const $ = (id)=>document.getElementById(id);
    const ui = {
      locText:$("locText"), timeText:$("timeText"),
      headline1:$("headline1"), headline2:$("headline2"),
      yTitle:$("yTitle"), tTitle:$("tTitle"),
      yTemp:$("yTemp"), yRain:$("yRain"), yWind:$("yWind"),
      tTemp:$("tTemp"), tRain:$("tRain"), tWind:$("tWind"),
      tTempDelta:$("tTempDelta"), tRainDelta:$("tRainDelta"), tWindDelta:$("tWindDelta"),
      amLbl:$("amLbl"), noonLbl:$("noonLbl"), eveLbl:$("eveLbl"),
      amLine:$("amLine"), noonLine:$("noonLine"), eveLine:$("eveLine"),
      amTom:$("amTom"), noonTom:$("noonTom"), eveTom:$("eveTom"),
      tip1:$("tip1"), tip2:$("tip2"), tip3:$("tip3"),
      locBtn:$("locBtn")
    };

    document.querySelectorAll('.lang button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.lang button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        LANG = btn.dataset.lang;
        renderTextsOnly();
      });
    });

    ui.locBtn.addEventListener('click', ()=>{
      navigator.geolocation.getCurrentPosition(async pos=>{
        await loadAll(pos.coords.latitude, pos.coords.longitude, true);
      }, async err=>{
        alert(LANG==='ko'?'ìœ„ì¹˜ ê¶Œí•œ ì‹¤íŒ¨. ì„œìš¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.':LANG==='ja'?'ä½ç½®æƒ…å ±ã®è¨±å¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚½ã‚¦ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚':'Location permission failed. Falling back to Seoul.');
        await loadAll(37.5665,126.9780,true);
      }, {enableHighAccuracy:false, timeout:4000});
    });

    // ====== ìœ í‹¸ ======
    function tempPhrase(dT, lang='ko'){
      if (dT==null) return '';
      const abs = Math.abs(dT);
      if (abs < 1) return lang==='en'?'about the same':(lang==='ja'?'ã»ã¼åŒã˜':'ê±°ì˜ ê°™ìŒ');
      if (dT >= 1 && dT < 3) return (lang==='en'?'a bit ':'ì•½ê°„ ') + (lang==='ja'?'æš–ã‹ã„':'ë” ë”°ëœ»');
      if (dT >= 3) return lang==='en'?'warmer':(lang==='ja'?'æš–ã‹ã„':'ë” ë”°ëœ»');
      if (dT <= -1 && dT > -3) return (lang==='en'?'a bit ':'ì•½ê°„ ') + (lang==='ja'?'æ¶¼ã—ã„':'ì„œëŠ˜');
      return lang==='en'?'cooler':(lang==='ja'?'æ¶¼ã—ã„':'ì„œëŠ˜');
    }
    function fmtTemp(v){ return (v!=null && isFinite(v)) ? `${Math.round(v)}Â°C` : 'â€”'; }
    function fmtMs(v){ return (v!=null && isFinite(v)) ? `${Math.round(v)} m/s` : 'â€”'; }
    function fmtMm(v){ if (v==null || !isFinite(v)) return 'â€”'; if (v < 0.1) return '0 mm'; return `${(Math.round(v*10)/10).toFixed(1)} mm`; }
    function fmtPop(v){ if (v==null || !isFinite(v)) return 'â€”'; return `${Math.round(v)}%`; }
    function nearestIndex(times, target){
      let best = 0, bestDiff = Infinity;
      for (let i=0;i<times.length;i++){
        const d = Math.abs(new Date(times[i]).getTime() - target.getTime());
        if (d<bestDiff){best=i;bestDiff=d;}
      }
      return best;
    }
    function avgForHours(values, times, dateBase, hours){
      const y = dateBase.getFullYear();
      const m = (dateBase.getMonth()+1).toString().padStart(2,'0');
      const d = dateBase.getDate().toString().padStart(2,'0');
      const prefix = `${y}-${m}-${d}T`;
      let acc=0, cnt=0;
      for (const h of hours){
        const key = `${prefix}${h.toString().padStart(2,'0')}:00`;
        const idx = times.indexOf(key);
        if (idx>=0 && values[idx]!=null){ acc += values[idx]; cnt++; }
      }
      return cnt? acc/cnt : null;
    }
    function setDeltaEl(el, val, unit){
      if (!el) return;
      const cls = (Math.abs(val) < (unit==='m/s'?1.5: unit==='mm'?0.2:1)) ? 'same' : (val>0?'up':'down');
      el.className = 'delta ' + cls;
      const sign = val>0?'+':'';
      const rounded = (unit==='mm') ? (Math.round(val*10)/10).toFixed(1) : Math.round(val);
      el.textContent = `${sign}${rounded}${unit}`;
    }

    // ====== ìƒíƒœ ======
    let ST = {
      lat: 37.5665, lon: 126.9780,
      locName: 'Seoul',
      tz: 'Asia/Seoul',
      now: new Date(),
      time: [],
      series: null,
      today: null, yesterday: null, tomorrow: null,
      deltasNow: null, deltasTomorrow: null
    };

    async function reverseGeocode(lat, lon){
      try{
        const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=${LANG}&format=json`;
        const r = await fetch(url); const j = await r.json();
        if (j && j.results && j.results.length){
          const top = j.results[0];
          const parts = [top.city || top.name, top.admin1, top.country_code].filter(Boolean);
          return parts.join(', ');
        }
      }catch(e){}
      return 'Unknown';
    }

    function summarizeForDate(dateObj){
      const H = ST.series; const time = ST.time;
      const slots = {
        am:[6,7,8,9], noon:[12,13,14,15], eve:[18,19,20,21]
      };
      const out = {};
      for (const [key, hours] of Object.entries(slots)){
        out[key] = {
          temp: avgForHours(H.temp, time, dateObj, hours),
          feels: avgForHours(H.feels, time, dateObj, hours),
          pop: avgForHours(H.pop, time, dateObj, hours),
          rain: avgForHours(H.rain, time, dateObj, hours),
          wind: avgForHours(H.wind, time, dateObj, hours),
        };
      }
      // now Â±1h
      const now = ST.now;
      let accT=0,cntT=0, accF=0,cntF=0, accP=0,cntP=0, accR=0,cntR=0, accW=0,cntW=0;
      for (let i=0;i<time.length;i++){
        const t = new Date(time[i]);
        if (t.toDateString()!==dateObj.toDateString()) continue;
        const diffH = Math.abs((t.getTime()-now.getTime())/3600000);
        if (diffH<=1){ 
          if (H.temp[i]!=null){accT+=H.temp[i]; cntT++;}
          if (H.feels[i]!=null){accF+=H.feels[i]; cntF++;}
          if (H.pop[i]!=null){accP+=H.pop[i]; cntP++;}
          if (H.rain[i]!=null){accR+=H.rain[i]; cntR++;}
          if (H.wind[i]!=null){accW+=H.wind[i]; cntW++;}
        }
      }
      out.now = {
        temp: cntT? accT/cntT : null,
        feels: cntF? accF/cntF : null,
        pop: cntP? accP/cntP : null,
        rain: cntR? accR/cntR : null,
        wind: cntW? accW/cntW : null,
      };
      return out;
    }

    function delta(a,b){ if (a==null || b==null) return null; return +(b-a).toFixed(1); }

    function computeHeadDelta(yToday, yOther){
      const a = yToday.now?.feels ?? yToday.now?.temp;
      const b = yOther.now?.feels ?? yOther.now?.temp;
      return delta(a,b);
    }

    function computeTips(summary){
      const umbrella = (summary.morning?.rain ?? 0) + (summary.noon?.rain ?? 0) + (summary.eve?.rain ?? 0) > 0.5
        || (summary.morning?.pop ?? 0) > 60 || (summary.noon?.pop ?? 0) > 60 || (summary.eve?.pop ?? 0) > 60;
      const jacket = (summary.morning?.feels ?? 20) < 18 || (summary.eve?.feels ?? 20) < 18;
      const uv = (summary.noon?.temp ?? 20) > 24 && (summary.noon?.pop ?? 0) < 50;
      return { umbrella, jacket, uv };
    }

    async function loadAll(lat, lon){
      ST.lat = lat; ST.lon = lon; ST.now = new Date();

      ui.headline1.textContent = texts[LANG].loading;
      ui.headline2.textContent = texts[LANG].loading2;

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
        `&hourly=temperature_2m,apparent_temperature,precipitation_probability,precipitation,wind_speed_10m`+
        `&past_days=1&forecast_days=2&timezone=auto`;
      const res = await fetch(url);
      const f = await res.json();

      ST.time = f.hourly.time;
      ST.series = {
        temp: f.hourly.temperature_2m,
        feels: f.hourly.apparent_temperature,
        pop: f.hourly.precipitation_probability,
        rain: f.hourly.precipitation,
        wind: f.hourly.wind_speed_10m
      };

      const now = ST.now;
      const yday = new Date(now.getTime()-24*60*60*1000);
      const tmr = new Date(now.getTime()+24*60*60*1000);

      ST.yesterday = summarizeForDate(yday);
      ST.today = summarizeForDate(now);
      ST.tomorrow = summarizeForDate(tmr);

      ST.locName = await reverseGeocode(lat, lon);

      renderAll();
    }

    function renderTextsOnly(){
      ui.yTitle.textContent = texts[LANG].yTitle;
      ui.tTitle.textContent = texts[LANG].tTitle;
      ui.amLbl.textContent = texts[LANG].am;
      ui.noonLbl.textContent = texts[LANG].noon;
      ui.eveLbl.textContent = texts[LANG].eve;
      ui.locBtn.textContent = texts[LANG].resetLoc;

      // ì¬ê³„ì‚°ëœ í—¤ë“œë¼ì¸
      if (ST.today && ST.yesterday){
        const d1 = computeHeadDelta(ST.yesterday, ST.today);
        const rainMsg1 = headRainMsg(ST.yesterday.now, ST.today.now);
        const windMsg1 = headWindMsg(ST.yesterday.now, ST.today.now);
        ui.headline1.textContent = texts[LANG].head1(d1, rainMsg1, windMsg1);
      }
      if (ST.today && ST.tomorrow){
        const d2 = computeHeadDelta(ST.today, ST.tomorrow);
        const rainMsg2 = headRainMsg(ST.today.now, ST.tomorrow.now);
        const windMsg2 = headWindMsg(ST.today.now, ST.tomorrow.now);
        ui.headline2.textContent = texts[LANG].head2(d2, rainMsg2, windMsg2);
      }
      ui.locText.textContent = ST.locName || 'Unknown';
      ui.timeText.textContent = new Date().toLocaleString();
      renderTips();
    }

    function headRainMsg(a,b){
      if (!a || !b) return null;
      const popA = a.pop ?? 0, popB = b.pop ?? 0;
      const diff = popB - popA;
      if (Math.abs(diff) < 10) return LANG==='en'?'rain similar':(LANG==='ja'?'é›¨ ã»ã¼åŒã˜':'ë¹„ ë¹„ìŠ·');
      return diff>0 ? (LANG==='en'?'rain chance â†‘':(LANG==='ja'?'é›¨ã®å¯èƒ½æ€§â†‘':'ë¹„ ê°€ëŠ¥ì„± â†‘'))
                    : (LANG==='en'?'rain chance â†“':(LANG==='ja'?'é›¨ã®å¯èƒ½æ€§â†“':'ë¹„ ê°€ëŠ¥ì„± â†“'));
    }
    function headWindMsg(a,b){
      if (!a || !b) return null;
      const diff = (b.wind ?? 0) - (a.wind ?? 0);
      if (Math.abs(diff) < 1.5) return null;
      return diff>0 ? (LANG==='en'?'windier':(LANG==='ja'?'é¢¨ãŒå¼·ã¾ã‚‹':'ë°”ëŒ ê°•í•´ì§'))
                    : (LANG==='en'?'calmer':(LANG==='ja'?'é¢¨ãŒå¼±ã¾ã‚‹':'ë°”ëŒ ì•½í•´ì§'));
    }

    function renderAll(){
      renderTextsOnly();

      // í˜„ì¬ì‹œê°„ í‘œê¸°
      ui.timeText.textContent = new Date().toLocaleString();

      // ì–´ì œ ì¹´ë“œ
      ui.yTemp.textContent = fmtTemp(ST.yesterday.now?.feels ?? ST.yesterday.now?.temp);
      ui.yRain.textContent = (ST.yesterday.now?.pop!=null) ? fmtPop(ST.yesterday.now.pop) : fmtMm(ST.yesterday.now?.rain);
      ui.yWind.textContent = fmtMs(ST.yesterday.now?.wind);

      // ì˜¤ëŠ˜ ì¹´ë“œ(+ë¸íƒ€: ì˜¤ëŠ˜-ì–´ì œ)
      const dTempNow = delta(ST.yesterday.now?.feels ?? ST.yesterday.now?.temp, ST.today.now?.feels ?? ST.today.now?.temp) ?? 0;
      const dRainNow = delta(ST.yesterday.now?.rain ?? 0, ST.today.now?.rain ?? 0) ?? 0;
      const dWindNow = delta(ST.yesterday.now?.wind ?? 0, ST.today.now?.wind ?? 0) ?? 0;

      ui.tTemp.innerHTML = `${fmtTemp(ST.today.now?.feels ?? ST.today.now?.temp)} <span id="tTempDelta" class="delta same">â€”</span>`;
      ui.tRain.innerHTML = `${(ST.today.now?.pop!=null)? fmtPop(ST.today.now.pop) : fmtMm(ST.today.now?.rain)} <span id="tRainDelta" class="delta same"></span>`;
      ui.tWind.innerHTML = `${fmtMs(ST.today.now?.wind)} <span id="tWindDelta" class="delta same"></span>`;

      ui.tTempDelta = document.getElementById('tTempDelta');
      ui.tRainDelta = document.getElementById('tRainDelta');
      ui.tWindDelta = document.getElementById('tWindDelta');

      setDeltaEl(ui.tTempDelta, dTempNow, "Â°C");
      setDeltaEl(ui.tRainDelta, dRainNow, "mm");
      setDeltaEl(ui.tWindDelta, dWindNow, "m/s");

      // ìŠ¬ë¡¯(ì˜¤ëŠ˜) + ë‚´ì¼ ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸
      function slotLine(y, t){
        const dT = delta(y?.feels ?? y?.temp, t?.feels ?? t?.temp);
        const rainTxt = (t?.pop!=null) ? `POP ${fmtPop(t.pop)}` : `RAIN ${fmtMm(t?.rain)}`;
        const windD = delta(y?.wind, t?.wind);
        const tempTxt = dT!=null ? `Î”T ${dT>0?'+':''}${Math.round(dT)}Â°C` : 'Î”T â€”';
        const windTxt = windD!=null ? `Î”W ${windD>0?'+':''}${Math.round(windD)} m/s` : 'Î”W â€”';
        return `${tempTxt} Â· ${rainTxt} Â· ${windTxt}`;
      }
      ui.amLine.textContent = slotLine(ST.yesterday.am, ST.today.am);
      ui.noonLine.textContent = slotLine(ST.yesterday.noon, ST.today.noon);
      ui.eveLine.textContent = slotLine(ST.yesterday.eve, ST.today.eve);

      function tomLine(t, tm){
        const dT = delta(t?.feels ?? t?.temp, tm?.feels ?? tm?.temp);
        const rainTxt = (tm?.pop!=null) ? `POP ${fmtPop(tm.pop)}` : `RAIN ${fmtMm(tm?.rain)}`;
        return (dT!=null ? `Î”T ${dT>0?'+':''}${Math.round(dT)}Â°C` : 'Î”T â€”') + ` Â· ${rainTxt}`;
      }
      ui.amTom.textContent = (LANG==='en'?'Tomorrow: ':(LANG==='ja'?'æ˜æ—¥: ':'ë‚´ì¼: ')) + tomLine(ST.today.am, ST.tomorrow.am);
      ui.noonTom.textContent = (LANG==='en'?'Tomorrow: ':(LANG==='ja'?'æ˜æ—¥: ':'ë‚´ì¼: ')) + tomLine(ST.today.noon, ST.tomorrow.noon);
      ui.eveTom.textContent = (LANG==='en'?'Tomorrow: ':(LANG==='ja'?'æ˜æ—¥: ':'ë‚´ì¼: ')) + tomLine(ST.today.eve, ST.tomorrow.eve);

      renderTips();
    }

    function renderTips(){
      const tipToday = computeTips(ST.today);
      ui.tip1.textContent = tipToday.umbrella ? texts[LANG].tips.takeUmb : texts[LANG].tips.noUmb;
      ui.tip2.textContent = tipToday.jacket ? texts[LANG].tips.outerNeed : texts[LANG].tips.outerMaybe;
      ui.tip3.textContent = texts[LANG].tips.uv;
    }

    // ì‹œì‘: ìœ„ì¹˜ ê¶Œí•œ â†’ ë¡œë“œ, ì‹¤íŒ¨ ì‹œ ì„œìš¸
    (async function start(){
      try{
        await new Promise((resolve)=>{
          navigator.geolocation.getCurrentPosition(async pos=>{
            await loadAll(pos.coords.latitude, pos.coords.longitude);
            resolve();
          }, async _=>{
            await loadAll(37.5665,126.9780); // Seoul fallback
            resolve();
          }, {enableHighAccuracy:false, timeout:4000});
        });
      }catch(e){
        await loadAll(37.5665,126.9780);
      }
    })();
  </script>
</body>
</html>
